<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Filipe J. Zabala" />


<title>BirdCLEF 2023 via voice</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">BirdCLEF 2023 via <code>voice</code></h1>
<h4 class="author">Filipe J. Zabala</h4>
<h4 class="date">2023-05-29 15:35:19</h4>


<div id="TOC">
<ul>
<li><a href="#context" id="toc-context">0. Context</a></li>
<li><a href="#libraries-and-functions" id="toc-libraries-and-functions">1. Libraries and functions</a>
<ul>
<li><a href="#installing" id="toc-installing">1.1 Installing</a></li>
<li><a href="#calling" id="toc-calling">1.2 Calling</a></li>
</ul></li>
<li><a href="#data" id="toc-data">2. Data</a>
<ul>
<li><a href="#downloading" id="toc-downloading">2.1 Downloading</a></li>
<li><a href="#extracting" id="toc-extracting">2.2 Extracting</a></li>
<li><a href="#train" id="toc-train">2.3 Train</a></li>
<li><a href="#test" id="toc-test">2.4 Test</a></li>
</ul></li>
<li><a href="#modelling" id="toc-modelling">3. Modelling</a>
<ul>
<li><a href="#objects" id="toc-objects">3.1 Objects</a></li>
<li><a href="#distances" id="toc-distances">3.2 Distances</a></li>
</ul></li>
</ul>
</div>

<div id="context" class="section level2">
<h2>0. Context</h2>
<p>This is a vignette presenting the <a href="https://cran.r-project.org/package=voice"><code>voice</code></a>
approach to <a href="https://www.kaggle.com/competitions/birdclef-2023/">Kaggle
BirdCLEF 2023</a> competition.</p>
</div>
<div id="libraries-and-functions" class="section level2">
<h2>1. Libraries and functions</h2>
<div id="installing" class="section level3">
<h3>1.1 Installing</h3>
<p><a href="https://github.com/filipezabala/birdclef2023"><code>birdclef2023</code></a>
contains summarized data from <a href="https://www.kaggle.com/competitions/birdclef-2023/">Kaggle
BirdCLEF 2023</a> competition audios. The summarization was made using
<a href="https://github.com/filipezabala/voice"><code>voice</code></a>,
an R library with functions to easily deal with audio.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install packs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;voice&#39;</span>, <span class="at">dep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&#39;filipezabala/birdclef2023&#39;</span>)</span></code></pre></div>
</div>
<div id="calling" class="section level3">
<h3>1.2 Calling</h3>
<p>The libraries are called, <code>geti</code> and <code>gaussian</code>
functions are defined.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(voice)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(birdclef2023)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># geti function</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>geti <span class="ot">&lt;-</span> <span class="cf">function</span>(x,i){x[i]}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># gaussian function</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>gaussian <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(<span class="sc">-</span>((x<span class="sc">-</span>mu)<span class="sc">/</span>sigma)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="data" class="section level2">
<h2>2. Data</h2>
<p>In this section is presented how to download, extract and summarize
the bird’s audio features. As the results are available at <a href="https://github.com/filipezabala/birdclef2023"><code>birdclef2023</code></a>,
this section may be ommited in a first reading.</p>
<div id="downloading" class="section level3">
<h3>2.1 Downloading</h3>
<p>The data may be downloaded by the <a href="https://github.com/Kaggle/kaggle-api">official Kaggle API</a>. The
zip file occupies around 5.3GB on disk.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">&#39;https://storage.googleapis.com/kaggle-competitions-data/kaggle-v2/44224/5188730/bundle/archive.zip?GoogleAccessId=web-data@kaggle-161607.iam.gserviceaccount.com&amp;Expires=1685615147&amp;Signature=QeSfA1%2Bumjv4ND27r%2F7ln3XzHk%2F52GDgNq3EDtphEAKxQUkypPQHaIVCxlLFAnhfqtTM3V4mny0KtttbCXgseNaweq%2Bx1f1TjtY6DEjP%2FksG%2B%2BX0TiaLgl06xPhh1SZ%2FiZcCaEtESL3SKAZ9Nq5%2FbSoNKTzghgPP2ET4ncUxc5UeaqR6%2BVTtSWLDCEe%2FEzPHOT64gaF9w4gAnqZjkl7GFthY034mXaBSULWl1Ul6K55vX%2FJfXbaxDzrJbVB1HlU0eax3MZcnyy9msHSwWEsH8N08pSYtWJZA4GmPoGUn5YrNRr5%2Bc7YYVKWKKPxmH%2FG7%2Fw7Y3gj7vd7etLLBzcjRBA%3D%3D&amp;response-content-disposition=attachment%3B+filename%3Dbirdclef-2023.zip&#39;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="dv">9999</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> url, <span class="st">&#39;~/Downloads/birdclef-2023.zip&#39;</span>, <span class="at">mode =</span> <span class="st">&#39;wd&#39;</span>)</span></code></pre></div>
</div>
<div id="extracting" class="section level3">
<h3>2.2 Extracting</h3>
<p>Taking a look.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">unzip</span>(<span class="st">&#39;~/Downloads/birdclef-2023.zip&#39;</span>, <span class="at">list =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                                    Name     Length                Date</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1              eBird_Taxonomy_v2021.csv 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2                 sample_submission.csv 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 test_soundscapes/soundscape_29201.ogg 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4      train_audio/abethr1/XC128013.ogg 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5      train_audio/abethr1/XC363501.ogg 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6      train_audio/abethr1/XC363502.ogg 4294967295 2023-03-06 18:35:00</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(<span class="fu">unzip</span>(<span class="st">&#39;~/Downloads/birdclef-2023.zip&#39;</span>, <span class="at">list =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 16945</span></span></code></pre></div>
<p>Unzipping.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">&#39;~/Downloads/birdclef-2023.zip&#39;</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">exdir =</span> <span class="fu">tempdir</span>(),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">unzip =</span> <span class="st">&#39;/usr/bin/unzip&#39;</span>)</span></code></pre></div>
</div>
<div id="train" class="section level3">
<h3>2.3 Train</h3>
<p>The .ogg files are converted using <a href="https://ffmpeg.org/"><code>ffmpeg</code></a>, “[a] complete,
cross-platform solution to record, convert and stream audio and video”.
The tagging procedure was performed by <code>voice::tag</code> using
parallel processing. In order to save memory, the ogg to wav conversion,
tagging and the wav files deletion are executed in the same routine. The
processing took around 6 hours on a local machine with 12 CPUs, and the
output is available in <code>birdclef2023::E_train</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ogg files</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>oggFiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/train_audio&#39;</span>), </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pattern =</span> <span class="st">&#39;.[Oo][Gg][Gg]$&#39;</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(oggFiles)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ogg directories</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>oggDirs <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">dirname</span>(oggFiles))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(oggDirs)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># wav files</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>new_pth <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/wav/&#39;</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>old_pth <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/train_audio/&#39;</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>wavFiles <span class="ot">&lt;-</span> <span class="fu">sub</span>(old_pth, new_pth, oggFiles)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>wavFiles <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&#39;.ogg$&#39;</span>, <span class="st">&#39;.wav&#39;</span>, wavFiles)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># wav directories</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>wavDirs <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">dirname</span>(wavFiles))</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># extended dataset</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(oggDirs)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>E_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&#39;list&#39;</span>, n)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(E_list) <span class="ot">&lt;-</span> <span class="fu">basename</span>(oggDirs)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># converting ogg to wav, tagging grouping by wav_path, deleting wav</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># garbage collector</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># creating directories</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>((wavDirs[i]), <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filtering by species_code</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  oggTemp <span class="ot">&lt;-</span> <span class="fu">dir</span>(oggDirs[i], <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  fltr <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="fu">basename</span>(oggDirs[i]), wavFiles)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  wavTemp <span class="ot">&lt;-</span> wavFiles[fltr]</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># converting ogg to wav</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(oggTemp)){</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    cmd <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;ffmpeg -i &quot;</span>, oggTemp[j], <span class="st">&quot; -ac 1 &quot;</span>, wavTemp[j])</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(cmd)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extended dataset</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  E <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">species_code =</span> <span class="fu">basename</span>(oggDirs[i]),</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">wav_path =</span> wavTemp)  </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tagging</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  E_list[[i]] <span class="ot">&lt;-</span> voice<span class="sc">::</span><span class="fu">tag</span>(E, <span class="at">groupBy =</span> <span class="st">&#39;species_code&#39;</span>,</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                            <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&#39;f0&#39;</span>, <span class="st">&#39;fmt&#39;</span>, <span class="st">&#39;rf&#39;</span>, <span class="st">&#39;rpf&#39;</span>, <span class="st">&#39;rcf&#39;</span>,</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">&#39;mfcc&#39;</span>, <span class="st">&#39;zcr&#39;</span>, <span class="st">&#39;rms&#39;</span>, <span class="st">&#39;gain&#39;</span>, <span class="st">&#39;rfc&#39;</span>))</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># binding</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>  E <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(E_list)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(E, <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="fu">gzfile</span>(<span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/E_train.csv.gz&#39;</span>)))</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># deleting wav files</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(wavDirs[i], <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># progress</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i<span class="sc">/</span>n)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="test" class="section level3">
<h3>2.4 Test</h3>
<p>Converting the test file from ogg to wav format.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># converting test data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>oggFile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/test_soundscapes/soundscape_29201.ogg&#39;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>wavFile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/test_soundscapes/soundscape_29201.wav&#39;</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>cmd <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;ffmpeg -y -i &quot;</span>, oggFile, <span class="st">&quot; -ac 1 &quot;</span>, wavFile)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(cmd)</span></code></pre></div>
<p>Splitting the 10 minutes file using <code>voice::splitw</code>. The
procedure took around 25 seconds.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rttm</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">*</span><span class="dv">60</span><span class="sc">/</span><span class="dv">5</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>rttm <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">type =</span> <span class="fu">rep</span>(<span class="st">&#39;SPEAKER&#39;</span>, n),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">file =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">chnl =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tbeg =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">595</span>,<span class="dv">5</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tdur =</span> <span class="fu">rep</span>(<span class="dv">5</span>,n),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ortho =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">stype =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="fu">rep</span>(<span class="st">&#39;A&#39;</span>,n),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">conf =</span> <span class="fu">rep</span>(<span class="cn">NA</span>,n),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">slat =</span> <span class="fu">rep</span>(<span class="cn">NA</span>,n))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(rttm, <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/split5sec.rttm&#39;</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># splitting</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>splitDir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/split&#39;</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(splitDir)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>voice<span class="sc">::</span><span class="fu">splitw</span>(wavFile, </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">fromRttm =</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/split5sec.rttm&#39;</span>),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">toSplit =</span> splitDir)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># renaming</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>fr <span class="ot">&lt;-</span> <span class="fu">dir</span>(splitDir, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>row_id_temp <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;soundscape_29201_&#39;</span>, <span class="fu">seq</span>(<span class="dv">5</span>,<span class="dv">600</span>,<span class="dv">5</span>), <span class="st">&#39;.wav&#39;</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>to <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">dirname</span>(fr), <span class="st">&#39;/&#39;</span>, row_id_temp)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="fu">file.rename</span>(fr,to)</span></code></pre></div>
<p>Finally the tagging is applied to the test data. The procedure took
less than 1 minute to run, and the output is available in
<code>birdclef2023::E_test</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extended dataset</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>row_id_raw <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(row_id_temp, <span class="st">&#39;.wav$&#39;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>row_id_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(row_id_raw, geti, <span class="dv">1</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">row_id =</span> row_id_raw,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">wav_path =</span> to)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># tagging grouping by row_id</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>tst <span class="ot">&lt;-</span> voice<span class="sc">::</span><span class="fu">tag</span>(E, <span class="at">groupBy =</span> <span class="st">&#39;row_id&#39;</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&#39;f0&#39;</span>, <span class="st">&#39;fmt&#39;</span>, <span class="st">&#39;rf&#39;</span>, <span class="st">&#39;rpf&#39;</span>, <span class="st">&#39;rcf&#39;</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;mfcc&#39;</span>, <span class="st">&#39;zcr&#39;</span>, <span class="st">&#39;rms&#39;</span>, <span class="st">&#39;gain&#39;</span>, <span class="st">&#39;rfc&#39;</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sortByGroupBy =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># writing</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(E, <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">file =</span> <span class="fu">gzfile</span>(<span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/E_test.csv.gz&#39;</span>)))</span></code></pre></div>
</div>
</div>
<div id="modelling" class="section level2">
<h2>3. Modelling</h2>
<div id="objects" class="section level3">
<h3>3.1 Objects</h3>
<p>The <code>birdclef2023::E_train</code> object contains 264 rows and
486 columns extracted via <code>voice::tag</code> from Kaggle
BirdCLEF2023 <code>train_audio</code> directory.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>birdclef2023<span class="sc">::</span>E_train</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 264 × 487</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    species_code f0_tag_mean f1_tag_mean f2_tag_mean f3_tag_mean f4_tag_mean</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;              &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 abethr1             80.0       1125.       1860.       2701.       3564.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 abhori1            122.         860.       1686.       2627.       3543.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 abythr1             90.3       1085.       1818.       2624.       3462.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 afbfly1            104.        1159.       1866.       2753.       3621.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 afdfly1            108.        1289.       2091.       2942.       3791.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 afecuc1            115.         978.       1801.       2654.       3559.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 affeag1            169.         934.       1588.       2566.       3486.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 afgfly1             95.8        869.       1736.       2677.       3550.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 afghor1            133.        1003.       1909.       2602.       3549.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 afmdov1            397.         636.       1577.       2558.       3492.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 254 more rows</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 481 more variables: f5_tag_mean &lt;dbl&gt;, f6_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   f7_tag_mean &lt;dbl&gt;, f8_tag_mean &lt;dbl&gt;, zcr1_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rms_tag_mean &lt;dbl&gt;, gain_tag_mean &lt;dbl&gt;, rfc1_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc2_tag_mean &lt;dbl&gt;, rfc3_tag_mean &lt;dbl&gt;, rfc4_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc5_tag_mean &lt;dbl&gt;, rfc6_tag_mean &lt;dbl&gt;, rfc7_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc8_tag_mean &lt;dbl&gt;, rfc9_tag_mean &lt;dbl&gt;, rfc10_tag_mean &lt;dbl&gt;, …</span></span></code></pre></div>
<p>The <code>birdclef2023::E_test</code> object contains 120 rows and
486 columns extracted via <code>voice::tag</code> from Kaggle
BirdCLEF2023 <code>test_soundscapes</code> directory. Each row is
associated with a 5 seconds section of <code>soundscape_29201.ogg</code>
file.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>birdclef2023<span class="sc">::</span>E_test</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 120 × 487</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    row_id            f0_tag_mean f1_tag_mean f2_tag_mean f3_tag_mean f4_tag_mean</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;                   &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 soundscape_29201…        75.6       1488.       1855.       2868.       3833.</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 soundscape_29201…        NA         1466.       1809.       2817.       3800.</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 soundscape_29201…        65.3       1464.       1889.       2927.       3878.</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 soundscape_29201…        71.8       1332.       1768.       2797.       3759.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 soundscape_29201…        56.9       1349.       1787.       2806.       3796.</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 soundscape_29201…        79.0       1452.       1877.       2742.       3766.</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 soundscape_29201…        NA         1466.       1816.       2819.       3807.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 soundscape_29201…        78.4       1351.       1824.       2765.       3741.</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 soundscape_29201…        74.8       1421.       1813.       2819.       3773.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 soundscape_29201…        66.6       1376.       1798.       2830.       3781.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 110 more rows</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 481 more variables: f5_tag_mean &lt;dbl&gt;, f6_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   f7_tag_mean &lt;dbl&gt;, f8_tag_mean &lt;dbl&gt;, zcr1_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rms_tag_mean &lt;dbl&gt;, gain_tag_mean &lt;dbl&gt;, rfc1_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc2_tag_mean &lt;dbl&gt;, rfc3_tag_mean &lt;dbl&gt;, rfc4_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc5_tag_mean &lt;dbl&gt;, rfc6_tag_mean &lt;dbl&gt;, rfc7_tag_mean &lt;dbl&gt;,</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   rfc8_tag_mean &lt;dbl&gt;, rfc9_tag_mean &lt;dbl&gt;, rfc10_tag_mean &lt;dbl&gt;, …</span></span></code></pre></div>
</div>
<div id="distances" class="section level3">
<h3>3.2 Distances</h3>
<p>The basic idea is to compare each row from <code>E_test</code> (test
sample) with each row from <code>E_train</code> (reference values). The
comparison is made through a metric derived from the Euclidean distance,
taking the average of the valid values (not NA). We call
<code>Average Length</code> and it is given by <span class="math display">\[\begin{equation}
AL=\sqrt{\frac{\sum_{i=1}^{n-n_{NA}} (x_i-y_i)^2}{n-n_{NA}}}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distances</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_test), </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">ncol =</span> <span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_train))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(D) <span class="ot">&lt;-</span> birdclef2023<span class="sc">::</span>E_test<span class="sc">$</span>row_id</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(D) <span class="ot">&lt;-</span> birdclef2023<span class="sc">::</span>E_train<span class="sc">$</span>species_code</span></code></pre></div>
<p>The following code is completly not optimized, designed to be
intuitive and run below the 2 hours limit defined in the <a href="https://www.kaggle.com/competitions/birdclef-2023/">Kaggle
BirdCLEF 2023</a> competition rules. Takes around 30 minutes to run on a
local machine, and the output is available in
<code>birdclef2023::D</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculating distances</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_train)){</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_test)){</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> k<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    d2 <span class="ot">&lt;-</span> (birdclef2023<span class="sc">::</span>E_test[i,<span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> birdclef2023<span class="sc">::</span>E_train[j,<span class="sc">-</span><span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">length</span>(d2)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    nNA <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(d2))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    D[i,j] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(d2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">/</span>(n<span class="sc">-</span>nNA))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(k<span class="sc">/</span>(<span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_test)<span class="sc">*</span><span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_train)))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The probabilities are calculated considering the Gaussian function
given by <span class="math display">\[\begin{equation}
g(x)=e^{-\left(\frac{x-\mu}{\sigma}\right)^2}
\end{equation}\]</span> <span class="math inline">\(x\)</span>
represents the scaled distances, and the parameters used were <span class="math inline">\(\mu=0\)</span> and <span class="math inline">\(\sigma=0.001\)</span>. The idea is to give more
weight to distance values very close to zero, and quickly reduce the
weight to distances that move away from zero, reason why the standard
deviation is small (adjusted to 0.001).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probabilities matrix</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_test), </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">ncol =</span> <span class="fu">nrow</span>(birdclef2023<span class="sc">::</span>E_train))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(P) <span class="ot">&lt;-</span> birdclef2023<span class="sc">::</span>E_test<span class="sc">$</span>row_id</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(P) <span class="ot">&lt;-</span> birdclef2023<span class="sc">::</span>E_train<span class="sc">$</span>species_code</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># calculating probabilities</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(P)){</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">gaussian</span>(<span class="fu">scale</span>(birdclef2023<span class="sc">::</span>D[i,]), </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="fl">0.001</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  P[i,] <span class="ot">&lt;-</span> w<span class="sc">/</span><span class="fu">sum</span>(w)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>After that, there is some cleaning and tidying up.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>block <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">rownames</span>(P), <span class="st">&#39;_&#39;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>block <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sapply</span>(block, geti, <span class="dv">3</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">block =</span> block, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">row_id =</span> <span class="fu">rownames</span>(P), </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">as_tibble</span>(P))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">&lt;-</span> submission <span class="sc">%&gt;%</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(block) <span class="sc">%&gt;%</span> </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>block)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>submission</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 120 × 265</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    row_id      abethr1 abhori1 abythr1 afbfly1 afdfly1 afecuc1   affeag1 afgfly1</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;         &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 soundscape…       0       0       0       0       0       0 2.96e-187       0</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 soundscape…       0       0       0       0       0       0 0               0</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 110 more rows</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 256 more variables: afghor1 &lt;dbl&gt;, afmdov1 &lt;dbl&gt;, afpfly1 &lt;dbl&gt;,</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   afpkin1 &lt;dbl&gt;, afpwag1 &lt;dbl&gt;, afrgos1 &lt;dbl&gt;, afrgrp1 &lt;dbl&gt;, afrjac1 &lt;dbl&gt;,</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   afrthr1 &lt;dbl&gt;, amesun2 &lt;dbl&gt;, augbuz1 &lt;dbl&gt;, bagwea1 &lt;dbl&gt;, barswa &lt;dbl&gt;,</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   bawhor2 &lt;dbl&gt;, bawman1 &lt;dbl&gt;, bcbeat1 &lt;dbl&gt;, beasun2 &lt;dbl&gt;, bkctch1 &lt;dbl&gt;,</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   bkfruw1 &lt;dbl&gt;, blacra1 &lt;dbl&gt;, blacuc1 &lt;dbl&gt;, blakit1 &lt;dbl&gt;, blaplo1 &lt;dbl&gt;,</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; #   blbpuf2 &lt;dbl&gt;, blcapa2 &lt;dbl&gt;, blfbus1 &lt;dbl&gt;, blhgon1 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>Finally, the <code>submission.csv</code> file is written in the
desired directory.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(submission,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">file =</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;/submission.csv&#39;</span>))</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
